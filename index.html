<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Provel Print</title>
  <meta
    description="A CAD-type application that facilitates a faster turnaround time for amputees to receive 3D printed socket for a residual limb." />
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
  <link rel="mask-icon" href="/mask-icon.svg" color="#00e1ee" />
  <meta name="theme-color" content="#00e1ee" />
</head>

<body>
  <div id="app">
    <div id="menuBar">
      <div>
        <nav role="menubar">
          <div>

            <h1><a href="/">ProvelPrint</a></h1>

            <div class="menuBarButtonContainer">
              <button role="menuitem" aria-haspopup="true" class="menuBarButton">File</button>

              <div class="menuBarDropdown" role="menu">
                <label style="display: block" class="menuBarDropdownButton fileInputLabel" for="stlFileInput"
                  id="stlFileInputLabel">
                  Open STL file
                  <input role="menuitem" type="file" accept=".stl" id="stlFileInput" name="stlFileInput"
                    class="fileInput" />
                </label>

                <button role="menuitem" class="menuBarDropdownButton" id="clearModelButton" type="button">Clear
                  model</button>

                <button role="menuitem" class="menuBarDropdownButton" id="addTestStlButton" type="button">Load Test
                  Socket STL</button>

                <button role="menuitem" class="menuBarDropdownButton" id="addTestCylinderButton" type="button">Load Test
                  Cylinder STL</button>
              </div>
            </div>

            <div class="menuBarButtonContainer">
              <button role="menuitem" aria-haspopup="true" class="menuBarButton">Edit</button>

              <div class="menuBarDropdown" role="menu">
                <button role="menuitem" class="menuBarDropdownButton" id="addMaterialProfile" type="button">Add Material
                  Profile</button>
                <button role="menuitem" class="menuBarDropdownButton" id="editActiveMaterialProfile" type="button">Edit
                  Active Material
                  Profile</button>
                <button role="menuitem" class="menuBarDropdownButton" id="deleteMaterialProfile" type="button">Delete
                  Active Material
                  Profile</button>
              </div>
            </div>

            <button role="menuitem" class="menuBarButton noDropdown" id="helpButton" type="button">Help</button>

            <button role="menuitem" aria-haspopup="true" id="activateInfoDialog" class="menuBarButton noDropdown"
              type="button">Info</button>
          </div>

          <div>
            <button role="menuitem" aria-haspopup="true" id="activateSettingsDialog" class="menuBarButton noDropdown"
              type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3" />
                <path
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
              </svg></button>
          </div>
        </nav>
      </div>
    </div>

    <!-- Info Icon -->
    <!--<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="16" x2="12" y2="12" />
                <line x1="12" y1="8" x2="12.01" y2="8" />
              </svg>-->

    <main>
      <div id="userInterface">
        <form id="appForm" aria-labelledby="appFormTitle">
          <h2 id="appFormTitle" class="hide">Socket Print Settings</h2>
          <div class="form-group">
            <label for="ipAddressInput" style="margin-right:15px">IP Address and Port</label>
            <div id="ipAddress">
              <input style="padding-left: 5px; margin-right: 5px" type="text" id="ipAddressInput" name="ipAddress"
                value="" placeholder="192.168.X.XXX:xxxx" aria-required="true" aria-label="IP Address and Port" />
            </div>
          </div>

          <div aria-describedby="portStatusIcons">
            <span>Port Status</span>
            <div id="portStatusIcons" aria-live="polite">
              <p id="ipAddressSuccess" class="hide">Connected</p>
              <p id="ipAddressFailure">Disconnected</p>
            </div>
          </div>

          <div class="form-group">
            <label>Lock Position</label>
            <div id="lockPositionGroup" style="display: flex; gap: 20px; align-items: center;">
              <label for="lockPositionLeft" style="display: flex; align-items: center; gap: 5px;">
                <input type="radio" id="lockPositionLeft" name="lockPosition" value="left" checked />
                Left
              </label>
              <label for="lockPositionRight" style="display: flex; align-items: center; gap: 5px;">
                <input type="radio" id="lockPositionRight" name="lockPosition" value="right" />
                Right
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="cupSize">Cup Size</label>
            <select name="cupSize" id="cupSize" aria-label="Cup Size">
              <option value="84x38" selected>84 x 38</option>
              <option value="84x25">84 x 25</option>
            </select>
          </div>

          <div class="form-group">
            <label for="nozzleSize">Nozzle Size</label>
            <select name="nozzleSize" id="nozzleSize" aria-label="Nozzle Size">
              <option value="3">3mm</option>
              <option value="4">4mm</option>
              <option value="5" selected>5mm</option>
              <option value="6">6mm</option>
              <option value="7">7mm</option>
            </select>
          </div>

          <div class="form-group">
            <label for="layerHeight">Layer Height</label>
            <select name="layerHeight" id="layerHeight" aria-label="Layer Height">
              <option value="1" selected>1mm</option>
              <option value="1.5">1.5mm</option>
              <option value="2">2mm</option>
            </select>
          </div>

          <div class="form-group">
            <label for="activeMaterialProfile">Material</label>
            <select name="activeMaterialProfile" id="activeMaterialProfile" aria-label="Material"></select>
          </div>

          <div>
            <span>Nozzle Temp (C)</span><span id="nozzleTempDisplay">200</span>
          </div>

          <div>
            <span>Cup Temp (C)</span><span id="cupTempDisplay">130</span>
          </div>
        </form>

        <div id="printActions">
          <button type="button" id="generateGCodeButton">File</button>

          <button type="button" id="printerFileInput" name="printerFileInput">Print</button>
        </div>
      </div>

      <div id="secondaryInterface">
        <div id="provelPrint" aria-label="3D Print Preview Area">
          <span id="collisionWarning">Collision detected!</span>
          <span id="activeFileName">No file selected</span>
          <div id="estimatedPrintTimeContainer" aria-label="Estimated Print Time">
            <span>Estimated Print Time:</span>
            <span id="estimatedPrintTime">0m 0s</span>
          </div>
          <canvas id="modelViewer"></canvas>
        </div>

        <div id="editSocket" aria-label="Socket Edit Controls">
          <div id="rotateSocket">
            <span>Rotate 90</span>
            <button disabled id="coronalRotater" type="button">Coronal</button>
            <button disabled id="sagittalRotate" type="button">Sagittal</button>
            <button disabled id="transversalRotater" type="button">Transverse</button>
          </div>
          <div id="changePosition">
            <span>Translate</span>
            <label for="horizontalTranslate">X
              <input disabled id="horizontalTranslate" type="number" value="0" step="1" min="-100" max="100" />
            </label>
            <label for="depthTranslate">Y
              <input disabled id="depthTranslate" type="number" value="0" step="1" min="-100" max="100" />
            </label>
            <label for="verticalTranslate">Z
              <input disabled id="verticalTranslate" type="number" value="0" step="1" min="-100" max="100" />
            </label>
          </div>
        </div>
      </div>
    </main>
  </div>

  <material-profile-form></material-profile-form>

  <app-info></app-info>

  <app-settings></app-settings>

  <app-info></app-info>

  <div id="progressBarDiv" aria-live="polite" aria-label="Progress Bar">
    <icon-element type="loader"></icon-element>
    <label for="progressBar" id="progressBarLabel">0%</label>
    <progress id="progressBar" value="0" max="100"></progress>
  </div>

  <div id="loading" aria-live="assertive" aria-label="Loading Spinner">
    <icon-element type="loader"></icon-element>
  </div>

  <offline-indicator></offline-indicator>

  <script type="module" src="./src/renderer.ts"></script>

  <script>
    // Enhanced service worker registration with update handling
    if ('serviceWorker' in navigator) {
      // Register service worker for both HTTPS and localhost development
      const shouldRegister = location.protocol === 'https:';

      if (shouldRegister) {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registered successfully:', registration.scope);

            // Check for updates every 60 seconds
            setInterval(() => {
              registration.update();
            }, 60000);

            // Handle service worker updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New service worker is available, show update notification
                    if (confirm('A new version is available. Reload to update?')) {
                      window.location.reload();
                    }
                  }
                });
              }
            });
          })
          .catch(error => {
            console.error('Service Worker registration failed:', error);
          });
      }
    }
  </script>
</body>

</html>