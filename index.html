<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Provel Print</title>
  <meta
    description="A CAD-type application that facilitates a faster turnaround time for amputees to receive 3D printed socket for a residual limb." />
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
  <link rel="mask-icon" href="/mask-icon.svg" color="#00e1ee" />
  <meta name="theme-color" content="#00e1ee" />
</head>

<body>
  <div id="app">
    <menu-bar></menu-bar>

    <main id="application">
      <form id="appForm" aria-labelledby="appFormTitle">
        <div class="form-group">
          <app-input label="IP Address and Port" type="text" id="ipAddressInput" name="ipAddress" value=""
            placeholder="192.168.X.XXX:xxxx" aria-required="true" aria-label="IP Address and Port"></app-input>
        </div>

        <div class="form-group">
          <span id="portStatusLabel">Port Status</span>
          <div id="portStatusIcons" role="status" aria-live="polite" aria-labelledby="portStatusLabel">
            <p id="ipAddressSuccess" class="hide">Connected <i data-lucide="printer-check" aria-hidden="true"></i></p>
            <p id="ipAddressFailure">Disconnected</p>
          </div>
        </div>

        <div class="form-group">
          <span id="lockPositionLabel">Lock Position</span>
          <div id="lockPositionGroup" role="radiogroup" aria-labelledby="lockPositionLabel"
            style="display: flex; gap: 20px; align-items: center;">
            <label for="lockPositionLeft" style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" id="lockPositionLeft" name="lockPosition" value="left" checked />
              Left
            </label>
            <label for="lockPositionRight" style="display: flex; align-items: center; gap: 5px;">
              <input type="radio" id="lockPositionRight" name="lockPosition" value="right" />
              Right
            </label>
          </div>
        </div>

        <div class="form-group">
          <label for="cupSize">Cup Size</label>
          <select name="cupSize" id="cupSize">
            <option value="84x38" selected>84 x 38</option>
            <option value="84x25">84 x 25</option>
          </select>
        </div>

        <div class="form-group">
          <label for="nozzleSize">Nozzle Size</label>
          <select name="nozzleSize" id="nozzleSize">
            <option value="3">3mm</option>
            <option value="4">4mm</option>
            <option value="5" selected>5mm</option>
            <option value="6">6mm</option>
            <option value="7">7mm</option>
          </select>
        </div>

        <div class="form-group">
          <label for="layerHeight">Layer Height</label>
          <select name="layerHeight" id="layerHeight">
            <option value="0.75">0.75mm</option>
            <option value="1" selected>1mm</option>
            <option value="1.5">1.5mm</option>
            <option value="2">2mm</option>
          </select>
        </div>

        <div class="form-group">
          <label for="activeMaterialProfile">Material</label>
          <select name="activeMaterialProfile" id="activeMaterialProfile"></select>
        </div>

        <div class="form-group">
          <span>Nozzle Temp (C)</span>
          <p id="nozzleTempDisplay">200</p>
        </div>

        <div class="form-group">
          <span> Cup Temp (C)</span>
          <p id="cupTempDisplay">130</p>
        </div>

        <div id="printActions">
          <button type="button" id="generateGCodeButton" aria-label="Save G-Code file"><i data-lucide="file"
              aria-hidden="true"></i>File</button>

          <button type="button" id="printerFileInput" name="printerFileInput" aria-label="Send to printer"><i
              data-lucide="printer" aria-hidden="true"></i>
            Print</button>
        </div>
      </form>

      <div id="secondaryInterface">
        <div id="provelPrint" aria-label="3D Print Preview Area">
          <span id="collisionWarning">Interference!</span>
          <span id="activeFileName">No file selected</span>
          <div id="translateRotationControls">
            <div id="changePosition">
              <span><i data-lucide="move-3d" aria-hidden="true"></i> Translate</span>
              <app-input label="X" direction="row" disabled id="xTranslate" type="number" value="0" step="1" min="-100" max="100"
                aria-describedby="translateDisabledHint"></app-input>
              <app-input label="Y" direction="row" disabled id="yTranslate" type="number" value="0" step="1" min="-100" max="100"
                aria-describedby="translateDisabledHint"></app-input>
              <app-input label="Z" direction="row" disabled id="zTranslate" type="number" value="0" step="1" min="-100" max="100"
                aria-describedby="translateDisabledHint"></app-input>
              <span id="translateDisabledHint" class="hide">Load a model to enable translation controls</span>
            </div>

            <div id="rotateSocket">
              <span><i data-lucide="rotate-cw" aria-hidden="true"></i> Rotate 90Â°</span>
              <button disabled id="xRotate" type="button" aria-describedby="rotateDisabledHint">X</button>
              <button disabled id="yRotate" type="button" aria-describedby="rotateDisabledHint">Y</button>
              <button disabled id="zRotate" type="button" aria-describedby="rotateDisabledHint">Z</button>
              <span id="rotateDisabledHint" class="hide">Load a model to enable rotation controls</span>
            </div>

            <button id="toggleTransformControlsButton" type="button" aria-label="Toggle rotation controls" title="Toggle rotation controls"
              aria-pressed="false">
              <i data-lucide="rotate-3d" aria-hidden="true"></i> Rotate
            </button>
          </div>
          <div id="estimatedPrintTimeContainer" aria-label="Estimated Print Time">
            <span>Estimated Print Time:</span>
            <span id="estimatedPrintTime">0m 0s</span>
          </div>
          <canvas id="modelViewer" role="img" aria-label="3D model preview of the socket">Your browser does not support
            the canvas element.</canvas>
        </div>
      </div>
    </main>
  </div>

  <material-profile-form></material-profile-form>

  <app-info></app-info>

  <app-settings></app-settings>

  <app-info></app-info>

  <div id="progressBarDiv" aria-live="polite" aria-label="Progress Bar">
    <i data-lucide="loader" class="spin-icon"></i>
    <label for="progressBar" id="progressBarLabel">0%</label>
    <progress id="progressBar" value="0" max="100"></progress>
  </div>

  <div id="loading" aria-live="assertive" aria-label="Loading Spinner">
    <i data-lucide="loader" class="spin-icon"></i>
  </div>

  <offline-indicator></offline-indicator>

  <script type="module" src="./src/renderer.ts"></script>
  <script>
    // Enhanced service worker registration with update handling
    if ('serviceWorker' in navigator) {
      // Register service worker for both HTTPS and localhost development
      const shouldRegister = location.protocol === 'https:';

      if (shouldRegister) {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registered successfully:', registration.scope);

            // Check for updates every 60 seconds
            setInterval(() => {
              registration.update();
            }, 60000);

            // Handle service worker updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New service worker is available, show update notification
                    if (confirm('A new version is available. Reload to update?')) {
                      window.location.reload();
                    }
                  }
                });
              }
            });
          })
          .catch(error => {
            console.error('Service Worker registration failed:', error);
          });
      }
    }
  </script>
</body>

</html>