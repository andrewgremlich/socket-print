name: Build and Zip Vite Web Project

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install dependencies
        run: npm ci

      - name: Build Vite project
        run: npm run build

      - name: Zip dist folder
        run: |
          cd dist
          zip -r ../dist.zip .
        if: ${{ success() }}

      # - name: Create GitHub Release Draft
      #   id: create_release
      #   uses: actions/create-release@v1
      #   with:
      #     tag_name: v${{ env.VERSION }}
      #     release_name: ProvelPrint Web Release v${{ env.VERSION }}
      #     draft: true
      #     prerelease: false
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      # - name: Upload dist.zip to Release
      #   uses: actions/upload-release-asset@v1
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: ./dist.zip
      #     asset_name: dist.zip
      #     asset_content_type: application/zip
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Create GitHub deployment
      #   uses: chrnorm/deployment-action@v2
      #   id: deployment
      #   with:
      #     token: '${{ github.token }}'
      #     environment-url: ${{ vars.MY_APP }}
      #     environment: production

      # - name: Set up SSH Key and Deploy my App on Server
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.VPS_IP }}
      #     username: ${{ secrets.VPS_USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     port: 22
      #     script: |
      #       whoami
      #       ls -al

      - name: Copy files via SSH
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "dist.zip"
          target: ~/

      # - name: Set up SSH
      #   uses: webfactory/ssh-agent@v0.5.4
      #   with:
      #     ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      # - name: Send dist to DigitalOcean Droplet
      #   env:
      #     DO_HOST: ${{ secrets.DO_HOST }}
      #     DO_USER: ${{ secrets.DO_USER }}
      #   run: |
      #     scp -o StrictHostKeyChecking=no dist.zip $DO_USER@$DO_HOST:/var/www/
      #     ssh -o StrictHostKeyChecking=no $DO_USER@$DO_HOST "unzip -o /var/www/dist.zip -d /var/www/"
      #     ssh -o StrictHostKeyChecking=no $DO_USER@$DO_HOST "rm /var/www/dist.zip"
      #   shell: bash
      #   if: ${{ success() }}

